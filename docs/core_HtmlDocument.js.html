<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/HtmlDocument.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core/HtmlDocument.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import Document from './Document';
import AnnotationSet from './AnnotationSet.js';

/**
 * Html document with html parser
 * @class nlpjs.core.HtmlDocument
 * @param {string} name - human readable name of the document
 * @property {nlpjs.core.AnnotationSet} annotations Annotaions of this document
 * @property {string} text Plain text of this document. Any HTML markup set to this property is automatically parsed
 * @property {number} size length of text
 * @extends nlpjs.core.Document
 * @example
 * var document = new HtmlDocument();
 * document.text = "Some &lt;b>bold&lt;/b> text";
 * document.text
 * // => "Some bold text";
 * document.annotations.type('html').first.text
 * // => bold
 * document.annotations.type('html').first.start
 * // => 5
 */
export default class HtmlDocument extends Document {

    constructor(name){
        super(name);

        var entityMap = {
            '&amp;nbsp;': ' ',
            '&amp;amp;' : '&amp;',
            '&amp;lt;'  : '&lt;',
            '&amp;gt;'  : '>',
            '&amp;quot;': '"',
            '&amp;#x27;': "'",
            '&amp;#39;' : "'"
        };

        if (typeof(document) !== 'undefined') {
            var unescapeDiv = document.createElement('div');
        }

        this.unescape = function(html){
            return html.replace(/&amp;#?[a-zA-Z0-9]+;/g, function(match){
                if (!entityMap[match] &amp;&amp; unescapeDiv){
                    unescapeDiv.innerHTML = match;
                    entityMap[match] = unescapeDiv.textContent || unescapeDiv.innerText;
                    console.log(entityMap);
                }
                return entityMap[match];
            });
        };

    }

    /**
     * @memberof nlpjs.core.HtmlDocument#text
     * @type {string}
     * @returns {string}
     */
    get text() {
        return this._text;
    }
    /**
     * Human readable text of the document
     *
     * html se to this property is parsed, html added to
     * annotations and just plaintext is left
     * @name nlpjs.core.HtmlDocument#text
     * @memberof nlpjs.core.HtmlDocument
     * @instance
     * @type {string}
     * @override
     */
    set text(text) {
        text = this._cleanupHtml(text);
        if (text.normalize)
            text.normalize();
        this._text = '';
        var matches = text.match(/(&lt;\/?[^>]+>)|([^&lt;]+)/gi);
        var position = 0;
        var tagStack = [];
        var annotations = [];
        var attrSet;
        var unpair = {
            br : true,
            img :true
        };
        var attributeMatcher = function(attr){
            attr = attr.match(/(\w+|-)(?:(?:=(["']?)(\S+)\2))?/);
            attrSet[attr[1]] = attr[3]||attr[1];
        };
        for (var i in matches){
            var match = matches[i];
            if (match[0] === '&lt;'){ // it's a tag
                var parts = match.match(/&lt;\/?(\S+)\s?(.*)>/);
                var tagname = parts[1];
                var attrs = parts[2];
                position = this._text.length;
                if (match[1] === '/') { // close
                    var popped = tagStack.pop();
                    while(popped !== undefined) {
                        popped.end = position;
                        annotations.push(popped);
                        if(popped.features.element == tagname)
                            break;
                        popped = tagStack.pop();
                    }
                } else { // open
                    attrSet = {
                        element : tagname
                    };
                    attrs.replace(/(\w|-)+(?:=(\S+))?/g, attributeMatcher);
                    var annotation = AnnotationSet.createAnnotation(position, position, 'html', attrSet);
                    if(unpair[tagname]){ // it's not pair element, close immediately
                        annotations.push(annotation);
                    } else {
                        tagStack.push(annotation);
                    }
                }
            } else { // it's not a tag
                this._text += this.unescape(match);
            }
        }
        this.annotations.add(annotations);
    }

    /**
     * Removes scripts, comments and unnessesary whitespaces
     * from document
     * @private
     * @method
     * @param {string} html html to be clean up
     * @return {string} cleaned up html
     * @name nlpjs.core.HtmlDocument#_cleanupHtml
     */
    _cleanupHtml(html) {
        return html.replace(/\n|\r/g, ' ')
            .replace(/&lt;(noscript|script|style).+?&lt;\/\1>/gi, '') //remove scripts and style
            .replace(/&lt;!--.+?-->/gi, '') //remove html comments
            .replace(/&lt;!\[CDATA\[.+?\]\]>/gi, '') //remove CDATA
            .replace(/\s+/g,' ');
    }

}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="nlpjs.classifier.AdaBoost.html">AdaBoost</a></li><li><a href="nlpjs.classifier.NaiveBayes.html">NaiveBayes</a></li><li><a href="nlpjs.classifier.NGram.html">NGram</a></li><li><a href="nlpjs.core.Annotation.html">Annotation</a></li><li><a href="nlpjs.core.AnnotationSet.html">AnnotationSet</a></li><li><a href="nlpjs.core.Container.html">Container</a></li><li><a href="nlpjs.core.Corpus.html">Corpus</a></li><li><a href="nlpjs.core.Document.html">Document</a></li><li><a href="nlpjs.core.HtmlDocument.html">HtmlDocument</a></li><li><a href="nlpjs.db.sparql.DBPediaEndpoint.html">DBPediaEndpoint</a></li><li><a href="nlpjs.db.sparql.Endpoint.html">Endpoint</a></li><li><a href="nlpjs.db.sparql.Query.html">Query</a></li><li><a href="nlpjs.distance.Hamming.html">Hamming</a></li><li><a href="nlpjs.distance.Levenshtein.html">Levenshtein</a></li><li><a href="nlpjs.stemmer.Hunspell.html">Hunspell</a></li><li><a href="nlpjs.tokenizer.CsTokenizer.html">CsTokenizer</a></li><li><a href="nlpjs.tokenizer.Tokenizer.html">Tokenizer</a></li><li><a href="StringBuffer.html">StringBuffer</a></li></ul><h3>Namespaces</h3><ul><li><a href="nlpjs.classifier.html">classifier</a></li><li><a href="nlpjs.core.html">core</a></li><li><a href="nlpjs.db.sparql.html">sparql</a></li><li><a href="nlpjs.distance.html">distance</a></li><li><a href="nlpjs.helpers.html">helpers</a></li><li><a href="nlpjs.stemmer.html">stemmer</a></li><li><a href="nlpjs.tokenizer.html">tokenizer</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta3</a> on Sat May 02 2015 20:05:35 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
